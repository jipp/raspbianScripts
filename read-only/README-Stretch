installation:

configuration:
prepare image before installation
cp config.txt config.txt.orig
cp cmdline.txt cmdline.txt.orig
sed -i s/" init=\/usr\/lib\/raspi-config\/init_resize.sh"// cmdline.txt

raspi-config
sudo raspi-config
1 Change User Password
2 Hostname
4 Localisation Options
I2 Change Timezone
I4 Change Wi-fi Country
5 Interfacing Options
P2 SSH
P5 I2C
P6 Serial
7 Advanced Options
A3 Memory Split

disable services
systemctl disable hciuart
patch -b /boot/config.txt config.txt.patch

Software update
sudo apt update
sudo apt list --upgradable
sudo apt -y upgrade

Software addon
sudo apt -y install ntp
sudo patch -b /etc/init.d/ntp ntp.patch
sudo systemctl daemon-reload

reboot

-> installation ready

disable swap
sudo systemctl stop dphys-swapfile
sudo systemctl disable dphys-swapfile
sudo dphys-swapfile swapoff
sudo dphys-swapfile uninstall

parition resize
sudo parted /dev/mmcblk0 print
sudo blkid
sudo parted /dev/mmcblk0 resizepart 2 8000M
sudo resize2fs /dev/mmcblk0p2
sudo blkid
sudo cp /etc/fstab /etc/fstab.orig
sudo vi /etc/fstab
sudo vi /boot/cmdline.txt

partition create
sudo parted /dev/mmcblk0 mkpart primary 15630336s 100%
sudo mkfs.ext4 /dev/mmcblk0p3
sudo mkdir /data
sudo vi /etc/fstab
sudo mount /data

reboot

-> repartitioning ready

fsck disable
sudo sed -i s/" fsck.repair=yes"// /boot/cmdline.txt

fstab
cat fstab-Stretch > /etc/fstab

resolv
mv /etc/resolv.conf /etc/resolv.conf.orig
ln -s /var/tmp/resolv.conf /etc/resolv.conf

daily_lock
mv /var/lib/apt/daily_lock /var/lib/apt/daily_lock.orig
ln -s /var/tmp/daily_lock /var/lib/apt/daily_lock

cron
mv /etc/fake-hwclock.data /etc/fake-hwclock.data.orig
ln -s /var/tmp/fake-hwclock.data /etc/fake-hwclock.data

dhcp
mv /etc/dhcpcd.secret /etc/dhcpcd.secret.orig
ln -s /var/tmp/dhcpcd.secret /etc/dhcpcd.secret

rsyslog
touch /etc/rsyslog.d/loghost.conf
patch -b /etc/rsyslog.d/loghost.conf loghost.conf.patch
systemctl restart rsyslog

-> fine tuning ready

create service:
touch /lib/systemd/system/setup-tmpfs.service
patch -b /lib/systemd/system/setup-tmpfs.service setup-tmpfs.service.patch
systemctl enable setup-tmpfs.service
mkdir /lib/systemd/scripts
touch /lib/systemd/scripts/setup-tmpfs.sh
patch -b /lib/systemd/scripts/setup-tmpfs.sh setup-tmpfs.sh-Stretch.patch
chmod +x /lib/systemd/scripts/setup-tmpfs.sh

modify mosquitto:
mkdir /data/mosquitto
chown -R mosquitto:root /data/mosquitto
patch -b /etc/mosquitto/mosquitto.conf mosquitto.conf.patch

modify lighttpd:
mv /var/lib/php5/sessions /var/lib/php5/sessions.orig
ln -s /var/tmp/sessions /var/lib/php5/sessions
mkdir /data/lighttpd
mv /var/www/html/esp /data/lighttpd/esp
chown -R www-data:www-data /data/lighttpd
ln -s /data/lighttpd/esp /var/www/html/esp



aliases
patch -b /etc/bash.bashrc bash.bashrc.patch



modify homegear:
patch -b /etc/homegear/main.conf main.conf.patch
patch -b /etc/homegear/php.ini php.ini.patch
patch -b /etc/homegear/homegear-start.sh homegear-start.sh.patch
mkdir -p /data/homegear/families
mkdir -p /data/homegear/db
mkdir -p /data/homegear/backup
mkdir -p /data/homegear/flows/data
chown homegear:homegear /data/homegear


enable/start:

backup:
